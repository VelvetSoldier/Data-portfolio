# A/B testing 

   create temporary table first_pageviews_demo 
    select
	wp.website_session_id,
    MIN(wp.website_pageview_id) as min_pageview_id
from website_pageviews wp
	join website_sessions ws
    on ws.website_session_id = wp.website_session_id
    and ws.created_at between "2014-01-01" and "2014-02-01"
group by
	wp.website_session_id;
    
CREATE TEMPORARY TABLE sessions_w_landing_page_demo
select 
	fd.website_session_id,
    wp.pageview_url as landing_page
From first_pageviews_demo fd
	left join website_pageviews wp
    on wp.website_pageview_id = fd.min_pageview_id;

    
Create temporary table bounced_sessions_only    
select
	swd.website_session_id,
    swd.landing_page,
    COUNT(wp.website_pageview_id) as count_of_pages_viewed
    
From sessions_w_landing_page_demo swd
left join website_pageviews wp 
on wp.website_session_id = swd.website_session_id
group by 
swd.website_session_id,
swd.landing_page
Having
	count(wp.website_pageview_id) = 1;
    
select
	swd.landing_page,
    count(distinct swd.website_session_id) as sessions,
    count(distinct bso.website_session_id) as bounced_sessions,
    count(distinct bso.website_session_id)/count(distinct swd.website_session_id) as bounce_rate
    from sessions_w_landing_page_demo swd
    left join bounced_sessions_only bso
    on swd.website_session_id = bso.website_session_id
    group by swd.landing_page

# Creating a conversion funnel

Select
COUNT(DISTINCT website_session_id) AS sessions,
    COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END)
    / COUNT(DISTINCT website_session_id) AS click_through_to_products,
    COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) 
    / COUNT(DISTINCT CASE WHEN product_made_it = 1 THEN website_session_id ELSE NULL END) AS click_through_to_mrfuzzy,
    COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) 
    / COUNT(DISTINCT CASE WHEN mrfuzzy_made_it = 1 THEN website_session_id ELSE NULL END) AS click_through_to_cart,
     COUNT(DISTINCT CASE WHEN shipping_made_it = 1 THEN website_session_id ELSE NULL END) 
    / COUNT(DISTINCT CASE WHEN cart_made_it = 1 THEN website_session_id ELSE NULL END) AS click_through_to_shipping,
     COUNT(DISTINCT CASE WHEN billing_made_it = 1 THEN website_session_id ELSE NULL END) 
    / COUNT(DISTINCT CASE WHEN shipping_made_it = 1 THEN website_session_id ELSE NULL END) AS click_through_to_billing,
     COUNT(DISTINCT CASE WHEN thankyou_made_it = 1 THEN website_session_id ELSE NULL END) 
    / COUNT(DISTINCT CASE WHEN billing_made_it = 1 THEN website_session_id ELSE NULL END) AS click_through_to_thankyou
    FROM (
    SELECT
	website_session_id,
    MAX(products_page) AS product_made_it,
    MAX(mrfuzzy_page) AS mrfuzzy_made_it,
    MAX(cart_page) AS cart_made_it,
    MAX(shipping_page) AS shipping_made_it,
    MAX(billing_page) AS billing_made_it,
    MAX(thankyou_page) AS thankyou_made_it
FROM (
Select
website_sessions.website_session_id,
website_pageviews.pageview_url,
website_pageviews.created_at AS pageview_created_at,
CASE WHEN pageview_url = '/products' THEN 1 ELSE 0 END AS products_page,
CASE WHEN pageview_url = '/the-original-mr-fuzzy' THEN 1 ELSE 0 END AS mrfuzzy_page,
CASE WHEN pageview_url = '/cart' THEN 1 ELSE 0 END AS cart_page,
CASE WHEN pageview_url = '/billing' THEN 1 ELSE 0 END AS billing_page,
CASE WHEN pageview_url = '/shipping' THEN 1 ELSE 0 END AS shipping_page,
CASE WHEN pageview_url = '/thank-you-for-your-order' THEN 1 ELSE 0 END AS thankyou_page
FROM website_sessions
LEFT JOIN website_pageviews
ON website_sessions.website_session_id = website_pageviews.website_session_id
WHERE website_sessions.created_at BETWEEN "2012-08-05" AND "2012-09-05"
AND website_pageviews.pageview_url 
IN ('/lander-1', '/products','/the-original-mr-fuzzy','/cart','/billing','/shipping','/thank-you-for-your-order')
order by website_sessions.website_session_id,
website_pageviews.created_at
) AS pageview_level
Group by website_session_id) as pageview_level_2;
