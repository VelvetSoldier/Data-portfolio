#Looking for the main traffic sources

SELECT 
    COUNT(DISTINCT website_session_id) AS Sessions,
    utm_source,
    utm_campaign AS campaign,
    http_referer AS domaine
FROM
    website_sessions
WHERE
    created_at < '2012-04-12'
GROUP BY utm_source , utm_campaign , http_referer
ORDER BY Sessions DESC;

# Analyzing session to order conversion_rate

SELECT 
    COUNT(DISTINCT w.website_session_id) AS number_of_sessions,
    COUNT(DISTINCT o.order_id) AS number_of_orders,
     COUNT(DISTINCT o.order_id) / COUNT(DISTINCT w.website_session_id)  AS conversion_rate
FROM
    website_sessions w
        LEFT JOIN
    orders o ON o.website_session_id = w.website_session_id
WHERE
    w.created_at < '2012-04-12'
        AND w.utm_source = 'gsearch'
        AND w.utm_campaign = 'nonbrand';

# Bid optimization impact analysis

SELECT 
    MIN(DATE(created_at)) AS dates,
    COUNT(DISTINCT website_session_id) AS sessions
FROM
    website_sessions
WHERE
    created_at < '2012-05-10'
        AND utm_source = 'gsearch'
        AND utm_campaign = 'nonbrand'
Group by WEEK(created_at);

# Gsearch conversion_rate mobile vs desktop

SELECT
	w.device_type,
    COUNT(DISTINCT w.website_session_id) AS number_of_sessions,
    COUNT(DISTINCT o.order_id) AS number_of_orders,
	COUNT(DISTINCT o.order_id)/ COUNT(DISTINCT w.website_session_id) AS conversion_rate
FROM
    website_sessions w
        LEFT JOIN
    orders o ON o.website_session_id = w.website_session_id
WHERE
    w.created_at < '2012-05-11'
        AND w.utm_source = 'gsearch'
        AND w.utm_campaign = 'nonbrand'
Group by 1;

# Website sessions numbers after the new device oriented bid changes

SELECT 
    MIN(DATE(created_at)) AS Dates,
    COUNT(DISTINCT CASE WHEN device_type = "mobile" THEN website_session_id else null end) AS mob_sessions,
	COUNT(DISTINCT CASE WHEN device_type = "desktop" THEN website_session_id else null end) AS dtop_sessions,
    COUNT(DISTINCT CASE WHEN device_type = "mobile" THEN website_session_id else null end)
	 + COUNT(DISTINCT CASE WHEN device_type = "desktop" THEN website_session_id else null end) AS Total_sessions
FROM
    website_sessions
WHERE
    created_at < '2012-06-09'
        AND utm_source = 'gsearch'
        AND utm_campaign = 'nonbrand'
Group by WEEK(created_at);

